---
image: debian:buster

stages:
  - pages

pages:
  stage: pages
  before_script:
    - apt-get update -qy > /dev/null
    - apt-get install gpg gnupg2 wget bzip2 -qy
    - apt-key adv --keyserver keyserver.ubuntu.com --recv-keys A0546A43624A8331
    - echo "deb http://repo.aptly.info/ squeeze main" >> /etc/apt/sources.list.d/aptly.list
    - apt-get update -qy > /dev/null
    - apt-get install aptly -qy
    - echo $GPG_PRIVATE_KEY| base64 -d > ${HOME}/gpg.key
    - gpg --import --no-tty --batch --yes ${HOME}/gpg.key
    - aptly repo create -distribution=xenial -component=main public
    - echo -e "use-agent\npinentry-mode loopback" > ~/.gnupg/gpg.conf
    - echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
  script:
    - mkdir dist/
    - >
      for package in $(cat PACKAGES); do
        FILE=$(echo $package |md5sum |cut -f1 -d" ")
        wget -O dist/$FILE.deb $package || true
      done
    - aptly repo add public ./dist/
##    - gpg --list-secret-keys --keyid-format=long
    - aptly publish repo -origin="japromis.gitlab.io/packages" -batch -passphrase=${GPG_PASSPHRASE} -gpg-key=${GPG_KEY_ID} public
    - mv ~/.aptly/public .
    - gpg --armor --output public/gpg.key --export ${GPG_KEY_ID}
  artifacts:
    paths:
      - public
    when: on_success
    expire_in: 1 year
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
